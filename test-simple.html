<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView 简单测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 10px 0;
            border: 1px solid #444;
        }
        .log {
            background: #2a2a2a;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <h1>TradingView 简单测试</h1>
    
    <div class="test-container">
        <h2>测试 1: 检查 TradingView 库</h2>
        <div id="library-status"></div>
    </div>
    
    <div class="test-container">
        <h2>测试 2: 创建 BTCUSDT 图表</h2>
        <div id="chart1" class="chart-container"></div>
        <div id="chart1-log" class="log"></div>
    </div>
    
    <div class="test-container">
        <h2>测试 3: 创建 BINANCE:BTCUSDT 图表</h2>
        <div id="chart2" class="chart-container"></div>
        <div id="chart2-log" class="log"></div>
    </div>
    
    <div class="test-container">
        <h2>测试 4: 创建无效 symbol 图表</h2>
        <div id="chart3" class="chart-container"></div>
        <div id="chart3-log" class="log"></div>
    </div>
    
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function checkLibrary() {
            const statusDiv = document.getElementById('library-status');
            
            if (typeof TradingView === 'undefined') {
                statusDiv.innerHTML = '<span class="error">❌ TradingView 库未加载</span>';
                log('chart1-log', 'TradingView 库未加载', 'error');
                return false;
            }
            
            if (typeof TradingView.widget === 'undefined') {
                statusDiv.innerHTML = '<span class="error">❌ TradingView.widget 未定义</span>';
                log('chart1-log', 'TradingView.widget 未定义', 'error');
                return false;
            }
            
            statusDiv.innerHTML = '<span class="success">✅ TradingView 库加载成功</span>';
            log('chart1-log', 'TradingView 库加载成功', 'success');
            return true;
        }
        
        function createChart(containerId, symbol, logId) {
            log(logId, `开始创建图表: ${symbol}`, 'info');
            
            try {
                const widget = new TradingView.widget({
                    width: '100%',
                    height: 400,
                    symbol: symbol,
                    interval: '5',
                    timezone: 'Asia/Shanghai',
                    theme: 'dark',
                    style: '1',
                    locale: 'zh_CN',
                    toolbar_bg: '#1e1e1e',
                    enable_publishing: false,
                    hide_top_toolbar: true,
                    hide_legend: true,
                    save_image: false,
                    container_id: containerId,
                    overrides: {
                        'paneProperties.background': '#1a1a1a',
                        'paneProperties.vertGridProperties.color': '#2a2a2a',
                        'paneProperties.horzGridProperties.color': '#2a2a2a'
                    },
                    disabled_features: [
                        'use_localstorage_for_settings',
                        'volume_force_overlay',
                        'create_volume_indicator_by_default',
                        'header_compare',
                        'header_undo_redo',
                        'header_screenshot',
                        'header_chart_type',
                        'header_settings',
                        'header_indicators',
                        'header_symbol_search',
                        'symbol_search_hot_key',
                        'header_resolutions',
                        'timeframes_toolbar'
                    ],
                    onChartReady: () => {
                        log(logId, `✅ 图表创建成功: ${symbol}`, 'success');
                        
                        widget.onChartReady(() => {
                            widget.chart().onSymbolChanged().subscribe(null, (symbolInfo) => {
                                if (symbolInfo && symbolInfo.error) {
                                    log(logId, `❌ Symbol 错误: ${symbolInfo.error}`, 'error');
                                } else {
                                    log(logId, `📊 Symbol 变更成功: ${JSON.stringify(symbolInfo)}`, 'success');
                                }
                            });
                        });
                    },
                    onError: (error) => {
                        log(logId, `❌ 图表错误: ${JSON.stringify(error)}`, 'error');
                    }
                });
                
                log(logId, `图表 widget 创建完成`, 'info');
                
            } catch (error) {
                log(logId, `❌ 创建图表异常: ${error.message}`, 'error');
                log(logId, `错误堆栈: ${error.stack}`, 'error');
            }
        }
        
        // 等待页面加载完成
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('chart1-log', '开始测试...', 'info');
                
                // 检查库
                if (!checkLibrary()) {
                    return;
                }
                
                // 测试不同的 symbol 格式
                setTimeout(() => createChart('chart1', 'BTCUSDT', 'chart1-log'), 1000);
                setTimeout(() => createChart('chart2', 'BINANCE:BTCUSDT', 'chart2-log'), 2000);
                setTimeout(() => createChart('chart3', 'INVALID:SYMBOL', 'chart3-log'), 3000);
                
            }, 1000);
        });
    </script>
</body>
</html>