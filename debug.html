<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .debug-info {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        #chart-container {
            width: 100%;
            height: 400px;
            background: #333;
            margin: 20px 0;
            border: 1px solid #555;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #005a8b;
        }
    </style>
</head>
<body>
    <h1>🔍 TradingView Debug Test</h1>
    
    <div class="debug-info">
        <h3>📊 Library Status</h3>
        <div id="library-status">检查中...</div>
    </div>
    
    <div class="debug-info">
        <h3>🧪 Test Controls</h3>
        <button class="test-button" onclick="testBTCUSDT()">测试 BINANCE:BTCUSDT</button>
        <button class="test-button" onclick="testETHUSDT()">测试 BINANCE:ETHUSDT</button>
        <button class="test-button" onclick="testDOGEUSDT()">测试 BINANCE:DOGEUSDT</button>
        <button class="test-button" onclick="testInvalidSymbol()">测试无效Symbol</button>
    </div>
    
    <div class="debug-info">
        <h3>📝 Console Output</h3>
        <div id="console-output" style="background: #000; padding: 10px; font-family: monospace; max-height: 200px; overflow-y: auto;"></div>
    </div>
    
    <div id="chart-container"></div>
    
    <!-- TradingView Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // 重写console.log来显示在页面上
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsoleOutput(type, ...args) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const color = {
                'log': '#00ff00',
                'error': '#ff0000',
                'warn': '#ffaa00'
            }[type] || '#ffffff';
            
            output.innerHTML += `<div style="color: ${color}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsoleOutput('log', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsoleOutput('error', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsoleOutput('warn', ...args);
        };
        
        let currentWidget = null;
        
        function checkLibraryStatus() {
            const statusDiv = document.getElementById('library-status');
            
            console.log('🔍 检查TradingView库状态...');
            
            if (typeof TradingView === 'undefined') {
                statusDiv.innerHTML = '❌ TradingView库未加载';
                console.error('❌ TradingView库未定义');
                return false;
            }
            
            if (typeof TradingView.widget === 'undefined') {
                statusDiv.innerHTML = '❌ TradingView.widget未定义';
                console.error('❌ TradingView.widget未定义');
                return false;
            }
            
            statusDiv.innerHTML = '✅ TradingView库已正确加载';
            console.log('✅ TradingView库状态正常');
            return true;
        }
        
        function createChart(symbol) {
            console.log(`🚀 尝试创建图表: ${symbol}`);
            
            if (!checkLibraryStatus()) {
                console.error('❌ 无法创建图表：库未正确加载');
                return;
            }
            
            // 清除现有图表
            if (currentWidget) {
                try {
                    currentWidget.remove();
                    console.log('🧹 已清除现有图表');
                } catch (e) {
                    console.warn('⚠️ 清除图表时出错:', e);
                }
            }
            
            // 清空容器
            const container = document.getElementById('chart-container');
            container.innerHTML = '';
            
            try {
                console.log(`📊 创建TradingView widget: ${symbol}`);
                
                currentWidget = new TradingView.widget({
                    width: '100%',
                    height: 400,
                    symbol: symbol,
                    interval: '5',
                    timezone: 'Asia/Shanghai',
                    theme: 'dark',
                    style: '1',
                    locale: 'zh_CN',
                    toolbar_bg: '#1e1e1e',
                    enable_publishing: false,
                    hide_top_toolbar: true,
                    hide_legend: true,
                    save_image: false,
                    container_id: 'chart-container',
                    onChartReady: function() {
                        console.log(`🎉 图表创建成功: ${symbol}`);
                    },
                    onError: function(error) {
                        console.error(`💥 图表创建失败: ${symbol}`, error);
                    }
                });
                
                console.log(`✅ Widget创建完成: ${symbol}`);
                
            } catch (error) {
                console.error(`💥 创建图表时发生异常: ${symbol}`, error);
                console.error(`💥 错误详情:`, error.stack);
            }
        }
        
        function testBTCUSDT() {
            createChart('BINANCE:BTCUSDT');
        }
        
        function testETHUSDT() {
            createChart('BINANCE:ETHUSDT');
        }
        
        function testDOGEUSDT() {
            createChart('BINANCE:DOGEUSDT');
        }
        
        function testInvalidSymbol() {
            createChart('BINANCE:INVALIDCOIN');
        }
        
        // 页面加载完成后检查状态
        window.addEventListener('load', function() {
            console.log('🌐 页面加载完成');
            
            // 等待TradingView库加载
            setTimeout(function() {
                checkLibraryStatus();
                
                // 自动测试BTCUSDT
                console.log('🔄 自动测试BTCUSDT...');
                testBTCUSDT();
            }, 2000);
        });
    </script>
</body>
</html>