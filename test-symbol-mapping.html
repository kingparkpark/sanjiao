<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symbol映射测试 - 三角形态检测</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #0a0a0a;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .symbol-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .symbol-input input {
            flex: 1;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
        }
        
        .symbol-input button {
            padding: 10px 20px;
            background: #2962ff;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        .symbol-input button:hover {
            background: #1e40af;
        }
        
        .test-results {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .symbol-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .symbol-card {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #444;
        }
        
        .symbol-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .symbol-mapping {
            font-size: 12px;
            color: #b2b5be;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-block;
        }
        
        .status.success {
            background: #26a69a;
            color: white;
        }
        
        .status.error {
            background: #ef5350;
            color: white;
        }
        
        .status.loading {
            background: #ffa726;
            color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-item {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #444;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 10px;
        }
        
        .log-area {
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Symbol映射测试</h1>
        <p>测试各种币种在TradingView中的symbol映射</p>
    </div>

    <div class="test-controls">
        <h3>测试Symbol映射</h3>
        <div class="symbol-input">
            <input type="text" id="customSymbol" placeholder="输入币种符号 (例如: WLFI, ALPACA, HEMI)" />
            <button onclick="testCustomSymbol()">测试</button>
            <button onclick="testAllSymbols()">测试所有</button>
            <button onclick="clearLogs()">清除日志</button>
        </div>
    </div>

    <div class="test-results">
        <h3>测试结果</h3>
        <div id="testResults"></div>
        <div class="log-area" id="logArea"></div>
    </div>

    <div class="charts-container" id="chartsContainer">
        <!-- 图表将在这里动态创建 -->
    </div>

    <!-- 引入TradingView库 -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <!-- 引入配置文件 -->
    <script src="js/config.js"></script>
    <script src="js/binanceDatafeed.js"></script>
    <script src="js/chartManager.js"></script>

    <script>
        // 测试用的币种列表
        const testSymbols = [
            'WLFI', 'ALPACA', 'HEMI', 'TRUMP', 'BONK', 'PEPE', 'DOGE', 'SHIB',
            'SOL', 'ADA', 'XRP', 'DOT', 'LINK', 'MATIC', 'AVAX', 'UNI',
            'LTC', 'BCH', 'ETC', 'XLM', 'VET', 'FIL', 'TRX', 'XMR',
            'ALGO', 'ATOM', 'XTZ', 'COMP', 'MKR', 'AAVE', 'SUSHI', 'YFI'
        ];

        let testChartManager;

        // 初始化
        function init() {
            testChartManager = new ChartManager();
            log('初始化完成，可以开始测试');
        }

        // 日志函数
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // 清除日志
        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
        }

        // 测试单个symbol
        function testSymbolMapping(symbol) {
            try {
                const mappedSymbol = testChartManager.getTradingViewSymbol(symbol);
                const alternatives = testChartManager.getAlternativeTradingViewSymbols(symbol);
                
                log(`测试 ${symbol} -> ${mappedSymbol}`);
                log(`备选方案: ${alternatives.slice(0, 5).join(', ')}...`);
                
                return {
                    symbol,
                    mappedSymbol,
                    alternatives: alternatives.slice(0, 5),
                    status: 'ready'
                };
            } catch (error) {
                log(`测试 ${symbol} 失败: ${error.message}`);
                return {
                    symbol,
                    mappedSymbol: null,
                    error: error.message,
                    status: 'error'
                };
            }
        }

        // 创建图表
        async function createTestChart(symbol) {
            const container = document.createElement('div');
            container.className = 'chart-item';
            container.innerHTML = `
                <div class="symbol-name">${symbol}</div>
                <div class="symbol-mapping" id="mapping-${symbol}">映射中...</div>
                <div class="status loading" id="status-${symbol}">加载中</div>
                <div class="chart-container" id="tradingview-${symbol}"></div>
            `;
            
            document.getElementById('chartsContainer').appendChild(container);
            
            try {
                const mappedSymbol = testChartManager.getTradingViewSymbol(symbol);
                document.getElementById(`mapping-${symbol}`).textContent = mappedSymbol;
                
                // 创建图表
                const widget = new TradingView.widget({
                    width: '100%',
                    height: 300,
                    symbol: mappedSymbol,
                    interval: '5',
                    timezone: 'Asia/Shanghai',
                    theme: 'dark',
                    style: '1',
                    locale: 'zh_CN',
                    toolbar_bg: '#1e1e1e',
                    enable_publishing: false,
                    hide_top_toolbar: true,
                    hide_legend: true,
                    save_image: false,
                    container_id: `tradingview-${symbol}`,
                    datafeed: new BinanceDatafeed(),
                    library_path: '/charting_library/',
                    onChartReady: () => {
                        document.getElementById(`status-${symbol}`).textContent = '成功';
                        document.getElementById(`status-${symbol}`).className = 'status success';
                        log(`${symbol} 图表创建成功`);
                    },
                    onError: (error) => {
                        document.getElementById(`status-${symbol}`).textContent = '失败';
                        document.getElementById(`status-${symbol}`).className = 'status error';
                        log(`${symbol} 图表创建失败: ${error}`);
                    }
                });
                
            } catch (error) {
                document.getElementById(`status-${symbol}`).textContent = '错误';
                document.getElementById(`status-${symbol}`).className = 'status error';
                log(`${symbol} 图表创建错误: ${error.message}`);
            }
        }

        // 测试自定义symbol
        function testCustomSymbol() {
            const symbol = document.getElementById('customSymbol').value.trim().toUpperCase();
            if (!symbol) {
                alert('请输入币种符号');
                return;
            }
            
            createTestChart(symbol);
            document.getElementById('customSymbol').value = '';
        }

        // 测试所有symbols
        function testAllSymbols() {
            document.getElementById('chartsContainer').innerHTML = '';
            
            testSymbols.forEach(symbol => {
                setTimeout(() => createTestChart(symbol), 100 * testSymbols.indexOf(symbol));
            });
            
            log(`开始测试 ${testSymbols.length} 个币种...`);
        }

        // 显示symbol映射结果
        function displaySymbolMappings() {
            const results = testSymbols.map(testSymbolMapping);
            const html = results.map(result => `
                <div class="symbol-card">
                    <div class="symbol-name">${result.symbol}</div>
                    <div class="symbol-mapping">${result.mappedSymbol}</div>
                    <div class="status success">已映射</div>
                </div>
            `).join('');
            
            document.getElementById('testResults').innerHTML = html;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            init();
            displaySymbolMappings();
        });

        // 支持回车键测试
        document.getElementById('customSymbol').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                testCustomSymbol();
            }
        });
    </script>
</body>
</html>